{{- $architecture := or .architecture "arm64" -}}
{{- $tarball := or .tarball (printf "ubuntu-touch-pdk-%s.tar.gz" $architecture) -}}
{{- $image := or .image (printf "ubuntu-touch-pdk-%s.raw" $architecture) -}}
{{- $cdimagesmirror := or .cdimagesmirror "http://cdimage.ubuntu.com" -}}

architecture: {{ $architecture }}
actions:
  - action: download
    description: Download Ubuntu Base, so that we don't have to run debootstrap
    url: "{{ $cdimagesmirror }}/ubuntu-base/releases/focal/release/ubuntu-base-20.04.2-base-{{ $architecture }}.tar.gz"
    unpack: false
    filename: ubuntu-base.tar.gz
    name: ubuntu-base.tar.gz

  - action: unpack
    description: Unpacking rootfs
    origin: ubuntu-base.tar.gz
    compression: gz

  - action: run
    chroot: true
    description: Setting password on root user
    command: echo root:root | chpasswd

  - action: download
    description: Download UBports keyring
    url: https://repo.ubports.com/keyring.gpg
    name: keyring

  - action: overlay
    description: Add UBports keyring to the rootfs
    origin: keyring
    destination: /etc/apt/trusted.gpg.d/ubports.gpg

  - action: run
    description: Add UBports focal repo
    # Note, this operation also updates packages in base image.
    chroot: true
    script: ../scripts/add-and-pin-repo.sh http://repo2.ubports.com/ focal 2000

  - action: run
    description: "[Temporary] add WIP repos"
    # Note, this operation also updates packages in base image.
    chroot: true
    script: >-
      ../scripts/add-and-pin-repo.sh
      http://repo2.ubports.com/ focal_-_PR_indicator-network_1 2001
      http://repo2.ubports.com/ focal_-_PR_lomiri_8 2001
      http://repo2.ubports.com/ focal_-_PR_ubuntu-touch-session_18 2001
      http://repo2.ubports.com/ focal_-_PR_repowerd_28 2001

  - action: run
    description: Install minimal debugging things
    chroot: true
    script: >-
      ../scripts/apt-install.sh
      ubuntu-minimal network-manager
      wpasupplicant openssh-server rfkill
      linux-image-generic libegl-mesa0
      libgbm1 libgl1-mesa-dri libgl1-mesa-glx
      libglapi-mesa libgles2-mesa libglx-mesa0
      libosmesa6 build-essential devscripts equivs git sshfs curl xterm
  # TODO: remove OpenSSH host keys and make it re-generate them on first boot.

  - action: run
    description: Add Ubuntu debug symbols repos
    chroot: true
    script: >-
      ../scripts/add-ubuntu-ddeb-repo.sh

  - action: run
    description: Install packages
    chroot: true
    script: >-
      ../scripts/apt-install.sh --no-install-recommends
      ubuntu-standard ubuntu-touch-session libnss-extrausers
      libqt5gui5-gles libqt5gui5-
      mir-graphics-drivers-desktop
      repowerd pulseaudio lxterminal
      nano bash-completion lomiri-greeter
      ubports-qa-scripts gdb valgrind
    label: apt-install.sh

{{ if eq $architecture "arm64" }}
  - action: run
    chroot: true
    description: Install arm64 GRUB
    script: >-
      ../scripts/apt-install.sh
      grub-efi-arm64 grub-efi-arm64-bin
{{ end }}

{{ if eq $architecture "amd64" }}
  - action: run
    chroot: true
    description: Install amd64 GRUB
    script: >-
      ../scripts/apt-install.sh
      grub-pc-bin
{{ end }}

  - action: run
    chroot: true
    description: Create default user
    command: groupadd -g 32011 phablet && useradd -g 32011 -u 32011 -m phablet && passwd -d phablet

  - action: overlay
    source: focal-pdk/overlay
    description: Adding generic overlay
    destination: /

  - action: pack
    file: {{ $tarball }}
    compression: gz

  - action: image-partition
    description: Creating image
    imagename: {{ $image }}
    imagesize: 15GB
    partitiontype: msdos
    mountpoints:
      - mountpoint: /
        partition: systemanddata
      - mountpoint: /boot
        partition: boot
      - mountpoint: /boot/efi
        partition: efi
    partitions:
      - name: efi
        fs: vfat
        start: 1M
        end: 200MB
        parttype: EF
        flags: [ esp ]
      - name: boot
        fs: ext2
        start: 200MB
        end: 500MB
      - name: systemanddata
        fs: ext4
        start: 500MB
        end: 100%

  - action: filesystem-deploy
    description: Deploying filesystem into image

  - action: run
    chroot: true
    command: update-grub && update-initramfs -u

{{ if eq $architecture "amd64" }}
  - action: run
    chroot: true
    command: grub-install /dev/vda --target=i386-pc
{{ end }}

{{ if eq $architecture "arm64" }}
  - action: run
    chroot: true
    command: grub-install --target=arm64-efi --no-nvram
{{ end }}

  - action: run
    description: PDK mount setup
    chroot: true
    command: mkdir -p /pdk/buildsources && mkdir -p /pdk/sources && systemctl enable ubports-pdk-mount.service
